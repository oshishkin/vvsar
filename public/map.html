<!DOCTYPE html>
<html>

<head>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700,800' rel='stylesheet' type='text/css'>
    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyC2bzkxOHWWS6DZnLh3g7lA7nOf48zes_k"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <style>
        #googleMap {
            height: 100%;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
    <script>
        function generateHash(d){return rstr2hex(binl2rstr(binl_md5(rstr2binl(d),8*d.length)))}
        function rstr2hex(d){for(var _,m="0123456789ABCDEF",f="",r=0;r<d.length;r++)_=d.charCodeAt(r),f+=m.charAt(_>>>4&15)+m.charAt(15&_);return f}
        function rstr2binl(d){for(var _=Array(d.length>>2),m=0;m<_.length;m++)_[m]=0;for(m=0;m<8*d.length;m+=8)_[m>>5]|=(255&d.charCodeAt(m/8))<<m%32;return _}
        function binl2rstr(d){for(var _="",m=0;m<32*d.length;m+=8)_+=String.fromCharCode(d[m>>5]>>>m%32&255);return _}
        function binl_md5(d,_){d[_>>5]|=128<<_%32,d[14+(_+64>>>9<<4)]=_;for(var m=1732584193,f=-271733879,r=-1732584194,i=271733878,n=0;n<d.length;n+=16){var h=m,t=f,g=r,e=i;f=md5_ii(f=md5_ii(f=md5_ii(f=md5_ii(f=md5_hh(f=md5_hh(f=md5_hh(f=md5_hh(f=md5_gg(f=md5_gg(f=md5_gg(f=md5_gg(f=md5_ff(f=md5_ff(f=md5_ff(f=md5_ff(f,r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+0],7,-680876936),f,r,d[n+1],12,-389564586),m,f,d[n+2],17,606105819),i,m,d[n+3],22,-1044525330),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+4],7,-176418897),f,r,d[n+5],12,1200080426),m,f,d[n+6],17,-1473231341),i,m,d[n+7],22,-45705983),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+8],7,1770035416),f,r,d[n+9],12,-1958414417),m,f,d[n+10],17,-42063),i,m,d[n+11],22,-1990404162),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+12],7,1804603682),f,r,d[n+13],12,-40341101),m,f,d[n+14],17,-1502002290),i,m,d[n+15],22,1236535329),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+1],5,-165796510),f,r,d[n+6],9,-1069501632),m,f,d[n+11],14,643717713),i,m,d[n+0],20,-373897302),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+5],5,-701558691),f,r,d[n+10],9,38016083),m,f,d[n+15],14,-660478335),i,m,d[n+4],20,-405537848),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+9],5,568446438),f,r,d[n+14],9,-1019803690),m,f,d[n+3],14,-187363961),i,m,d[n+8],20,1163531501),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+13],5,-1444681467),f,r,d[n+2],9,-51403784),m,f,d[n+7],14,1735328473),i,m,d[n+12],20,-1926607734),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+5],4,-378558),f,r,d[n+8],11,-2022574463),m,f,d[n+11],16,1839030562),i,m,d[n+14],23,-35309556),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+1],4,-1530992060),f,r,d[n+4],11,1272893353),m,f,d[n+7],16,-155497632),i,m,d[n+10],23,-1094730640),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+13],4,681279174),f,r,d[n+0],11,-358537222),m,f,d[n+3],16,-722521979),i,m,d[n+6],23,76029189),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+9],4,-640364487),f,r,d[n+12],11,-421815835),m,f,d[n+15],16,530742520),i,m,d[n+2],23,-995338651),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+0],6,-198630844),f,r,d[n+7],10,1126891415),m,f,d[n+14],15,-1416354905),i,m,d[n+5],21,-57434055),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+12],6,1700485571),f,r,d[n+3],10,-1894986606),m,f,d[n+10],15,-1051523),i,m,d[n+1],21,-2054922799),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+8],6,1873313359),f,r,d[n+15],10,-30611744),m,f,d[n+6],15,-1560198380),i,m,d[n+13],21,1309151649),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+4],6,-145523070),f,r,d[n+11],10,-1120210379),m,f,d[n+2],15,718787259),i,m,d[n+9],21,-343485551),m=safe_add(m,h),f=safe_add(f,t),r=safe_add(r,g),i=safe_add(i,e)}return Array(m,f,r,i)}function md5_cmn(d,_,m,f,r,i){return safe_add(bit_rol(safe_add(safe_add(_,d),safe_add(f,i)),r),m)}function md5_ff(d,_,m,f,r,i,n){return md5_cmn(_&m|~_&f,d,_,r,i,n)}function md5_gg(d,_,m,f,r,i,n){return md5_cmn(_&f|m&~f,d,_,r,i,n)}function md5_hh(d,_,m,f,r,i,n){return md5_cmn(_^m^f,d,_,r,i,n)}function md5_ii(d,_,m,f,r,i,n){return md5_cmn(m^(_|~f),d,_,r,i,n)}function safe_add(d,_){var m=(65535&d)+(65535&_);return(d>>16)+(_>>16)+(m>>16)<<16|65535&m}function bit_rol(d,_){return d<<_|d>>>32-_}
        function getQueryVariable(variable){var query = window.location.search.substring(1); var vars = query.split("&"); for (var i=0;i<vars.length;i++) { var pair = vars[i].split("="); if(pair[0] == variable){return pair[1];}} return(false);}
        
        function showLocalizations() {
            // initialize public variables and methods
            let markersArray = [];
            let phoneMarker = null;
            let phoneMarkerReal = null;
            let distanceCircle = null;

            const clearBusMarkers = () => {
                markersArray.forEach(marker => marker.setMap(null));
                markersArray.length = 0;
            }
        
            const clearMarkers = () => {
                // clear phone marker
                if (phoneMarker != null) {
                    phoneMarker.setMap(null);
                    phoneMarker = null;
                }

                // clear phone marker
                if (phoneMarkerReal != null) {
                    phoneMarkerReal.setMap(null);
                    phoneMarkerReal = null;
                }

                // clear circle
                if (distanceCircle != null) {
                    distanceCircle.setMap(null);
                    distanceCircle = null;
                }

                clearBusMarkers();
            }

            // initialize map
            const map = new google.maps.Map(
                document.getElementById('googleMap'),
                {
                    center: new google.maps.LatLng(55.7875328965814, 49.1810485487428),
                    zoom: 20,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    tilt: 0,
                    mapTypeControl: false
                }
            );
            let mode = getQueryVariable("mode");
            console.log("mode="+mode);
            
            if(mode==false){
                let hash = null;
                setInterval(async () => {
                    const response = await fetch('/api/lastpoints?cnt=1', {cache: 'no-store'});
                    const responseJson = await response.json();
                    const newHash = generateHash(JSON.stringify(responseJson));

                    responseJson.forEach(({data, startTimeMs}) => {
                        const startTime = new Date(startTimeMs - new Date().getTimezoneOffset() * 60 * 1000).toString();
                        // data[0] is request
                        if (data && data.length > 0) {
                            const { latitude, longitude, heading, precision } = data[0];
                            const myLatlng = new google.maps.LatLng(latitude, longitude);
                            const icon = {
                                path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                                scale: 5,
                                fillColor: "blue",
                                fillOpacity: 0.8,
                                strokeWeight: 2,
                                rotation: heading
                            };

                            if (phoneMarker == null) {
                                phoneMarker = new google.maps.Marker({
                                    position: myLatlng,
                                    map: map,
                                    title: startTime,
                                    icon: icon
                                });
                            } else {
                                phoneMarker.setPosition(myLatlng);
                                phoneMarker.setIcon(icon);
                                phoneMarker.setTitle(startTime);
                            }

                            
                            if (distanceCircle == null){
                                distanceCircle = new google.maps.Circle({
                                    center: myLatlng,
                                    map: map,
                                    strokeColor: '#000000',
                                    strokeOpacity: 0.1,
                                    strokeWeight: 1,
                                    fillColor: '#000000',
                                    fillOpacity: 0.1,
                                    radius: precision,
                                });
                            } else {
                                distanceCircle.setCenter(myLatlng);
                                distanceCircle.setRadius(precision);
                            }

                            // data[1] is response
                            if (data.length > 1) {
                                if (hash != newHash) clearBusMarkers();
                                
                                // iterage over busStops
                                data[1].forEach(({lat, lng, stop_name}) => {
                                    markersArray.push(new google.maps.Marker({
                                        position: new google.maps.LatLng(lat, lng),
                                        map: map,
                                        title: stop_name,
                                        icon: {
                                            url: '/marker.png',
                                            scaledSize: new google.maps.Size(40, 40)
                                        }
                                    }));
                                });

                                if(data.length>2){
                                    const myLatlng1 = new google.maps.LatLng(data[2].latitude, data[2].longitude);
                                    console.log(myLatlng+" "+myLatlng1);
                                    
                                    const icon1 = {
                                        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                                        scale: 5,
                                        fillColor: "green",
                                        fillOpacity: 0.8,
                                        strokeWeight: 2,
                                        rotation: heading
                                    };
                                    if (phoneMarkerReal == null) {
                                        phoneMarkerReal = new google.maps.Marker({
                                            position: myLatlng1,
                                            map: map,
                                            title: startTime,
                                            icon: icon1
                                        });
                                    } else {
                                        phoneMarkerReal.setPosition(myLatlng1);
                                        phoneMarkerReal.setIcon(icon1);
                                        phoneMarkerReal.setTitle("Real: "+startTime);
                                    }
                                }
                            }
                        } else {
                            clearMarkers();
                        }
                    });

                    // update map bounds if response hash changes
                    if (hash != newHash){
                        if (map && distanceCircle){
                            //
                            let latlngbounds = distanceCircle.getBounds();
                            if(phoneMarkerReal!=null) latlngbounds.extend(phoneMarkerReal.position);
                            map.fitBounds(latlngbounds);
                            var zoom = map.getZoom();
                            map.setZoom(zoom > 19 ? 19 : zoom);
                        }
                        hash = newHash;
                    }
                }, 1000);
            } else {
                let cnt = getQueryVariable("cnt");
                let startTime = getQueryVariable("startTime");
                let stopTime = getQueryVariable("stopTime");

                //datetime format YYYY-MM-DDTHH:MM:SS
                const datetimeRegexp = new RegExp('^\d\d\d\d-(0?[1-9]|1[0-2])-(0?[1-9]|[12][0-9]|3[01])T(00|[0-9]|1[0-9]|2[0-3]):([0-9]|[0-5][0-9]):([0-9]|[0-5][0-9])$');
                const startTimeIsValid = startTime!=false && datetimeRegexp.test(startTime);
                const stopTimeIsValid = stopTime!=false && datetimeRegexp.test(stopTime);
                
                let responseVars = startTimeIsValid ? "startTime="+startTime : "";
                responseVars = stopTimeIsValid ? (startTimeIsValid ? "&stopTime="+stopTime : "stopTime="+stopTime) : "";
                responseVars = (cnt!=false && cnt*1>0) ? (responseVars.length>0 ? "&cnt="+cnt : "cnt="+cnt) : "";
                
                setTimeout(async () => {
                    const responseUrl = '/api/waypoints';
                    const wayResponse = await fetch(responseUrl+'?'+responseVars, {cache: 'no-store'});
                    console.log(wayResponse);
                    const wayResponseJson = await wayResponse.json();
                    
                    let cntMarkers = [];
                    let path = [];
                    let avgPath = [];
                    const size = wayResponseJson.length;
                    wayResponseJson.forEach(({data, startTimeMs}, idx) => {
                        const startTime = new Date(startTimeMs - new Date().getTimezoneOffset() * 60 * 1000).toString();
                        if (data && data.length > 0) {
                            const { latitude, longitude, heading, precision } = data[0];
                            const myLatlng = new google.maps.LatLng(latitude, longitude);
                            avgPath.push(myLatlng);
                        
                            const icon = {
                                path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                                scale: 3+(idx/size)*2,//(idx/cnt)*10,//1.5/4,
                                fillColor: "blue",
                                fillOpacity: 0.8,
                                strokeColor: "white",
                                strokeWeight: 1,
                                rotation: heading
                            };
                            /*const crcl = new google.maps.Circle({
                                center: myLatlng,
                                map: map,
                                strokeColor: '#ffffff',
                                strokeOpacity: 0.01,
                                strokeWeight: 1,
                                fillColor: '#ffffff',
                                fillOpacity: 0.1,
                                radius: requestElement.precision-20,
                            });*/
                            cntMarkers.push(new google.maps.Marker({
                                position: myLatlng,
                                map: map,
                                title: startTime,
                                icon: icon
                            }));

                            if(data && data.length>2){
                                const myLatlng1 = new google.maps.LatLng(data[2].latitude, data[2].longitude);
                                path.push(myLatlng1);
                        
                                const icon1 = {
                                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                                    scale: 3+(idx/size)*2,
                                    fillColor: "green",
                                    fillOpacity: 0.8,
                                    strokeColor: "white",
                                    strokeWeight: 1,
                                    rotation: heading
                                };
                            
                                cntMarkers.push(new google.maps.Marker({
                                    position: myLatlng1,
                                    map: map,
                                    title: startTime,
                                    icon: icon1
                                }));
                            }
                        }
                    });

                    let avgLine = new google.maps.Polyline({
                        path: avgPath,
                        geodesic: true,
                        strokeColor: '#00ff00',
                        strokeOpacity: 0.5,
                        strokeWeight: 2,
                        map: map
                    });

                    let realLine = new google.maps.Polyline({
                        path: path,
                        geodesic: true,
                        strokeColor: '#0000ff',
                        strokeOpacity: 0.5,
                        strokeWeight: 2,
                        map: map
                    });

                    var bounds = new google.maps.LatLngBounds();
                    for (var i=0; i<cntMarkers.length; i++) {
                        bounds.extend( cntMarkers[i].getPosition() );
                    }
                    map.fitBounds(bounds);
                }, 1000);
            }
        }
    </script>
</head>

<body onload='showLocalizations()'>
    <div id="googleMap" style="top:0px;left:0px;width:100%;height:100%;">
</body>

</html>